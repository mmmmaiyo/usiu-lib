<!DOCTYPE html>

<!-- 
  Theme Name: Enlight
  Theme URL: https://probootstrap.com/enlight-free-education-responsive-bootstrap-website-template
  Author: ProBootstrap.com
  Author URL: https://probootstrap.com
  License: Released for free under the Creative Commons Attribution 3.0 license (probootstrap.com/license)
-->
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>USIU-Africa Library & Information Centre</title>

    <link href="https://fonts.googleapis.com/css?family=Raleway:300,400,500,700|Open+Sans" rel="stylesheet">
    <link rel="stylesheet" href="css/styles-merged.css">
    <link rel="stylesheet" href="css/style.min.css">
    <link rel="stylesheet" href="css/custom.css">

    <!--[if lt IE 9]>
      <script src="js/vendor/html5shiv.min.js"></script>
      <script src="js/vendor/respond.min.js"></script>
    <![endif]-->
</head>

<body>
    <!--SEARCH-->
    <div class="pbs-search" id="pbs-search">
        <a href="#" class="pbs-close js-pbs-close"><i class="icon-cross"></i></a>
        <!-- this is the search form we want it to have unique functionalities -->
        <form action="#">
            <input type="search" id="searchs" placeholder="Search a keyword and hit enter...">
        </form>
    </div>
    <!--LOGIN-->
    <div class="pbs-login" id="pbs-login">
        <div class="modal-content">
            <a href="#" class="pbs-closes js-pbs-closes"><i class="icon-cross"></i></a>
            <form id="login-form" action="#">
                <input type="text" id="username" placeholder="Username">
                <input type="password" id="password" placeholder="Password">
                <button class="btn btn-primary">Login</button>
            </form>
        </div>
    </div>

    <div class="pbs-page-wrapper">
        <!-- Fixed navbar -->

        <div class="pbs-header-top">
            <div class="container">
                <div class="row">
                    <div class="col-lg-9 col-md-9 col-sm-9 pbs-top-quick-contact-info">
                        <span><i class="icon-location2"></i>USIU Road, Off Thika Road (Exit 7)</span>
                        <span><i class="icon-phone2"></i>+254 730 116690</span>
                        <span><i class="icon-mail"></i>askalibrarian@usiu.ac.ke</span>
                    </div>
                    <div class="col-lg-3 col-md-3 col-sm-3 pbs-top-social">
                        <ul>
                            <li><a href="https://twitter.com/UsiuLibrary"><i class="icon-twitter"></i></a></li>
                            <li><a href="https://www.facebook.com/usiulibrary/"><i class="icon-facebook2"></i></a></li>
                            <li><a href="# " class="pbs-search-icon js-pbs-search "><i class="icon-search "></i></a></li>
                            <li><a href="#" class="pbs-login-icon js-pbs-login">Log In</a></li>
                            <li><a href="#" id="js-pbs-logout">Log Out</a></li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
        <nav class="navbar navbar-default pbs-navbar">
            <div class="container">
                <div class="navbar-header">
                    <div class="btn-more js-btn-more visible-xs">
                        <a href="#"><i class="icon-dots-three-vertical "></i></a>
                    </div>
                    <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar-collapse" aria-expanded="false" aria-controls="navbar">
              <span class="sr-only">Toggle navigation</span>
              <span class="icon-bar"></span>
              <span class="icon-bar"></span>
              <span class="icon-bar"></span>
            </button>
                    <a class="navbar-brand" href="index.html" title="USIU-A Library"><img src="img/usiu_400.jpg" id="usiu_logo"></a>
                </div>

                <div id="navbar-collapse" class="navbar-collapse collapse">
                    <ul class="nav navbar-nav navbar-right">
                        <li id="userAccount" style="visibility: hidden;"><a href="account.html">My Account</a></li>
                        <li><a href="index.html">Home</a></li>
                        <li class="dropdown">
                            <a href="#" data-toggle="dropdown" class="dropdown-toggle">Browse</a>
                            <ul class="dropdown-menu">
                                <li><a href="resources.html">eResources</a></li>
                                <li><a href="newspapers.html">eNewspapers</a></li>
                            </ul>
                        </li>
                        <li><a href="about-us.html">About Us</a></li>
                        <li><a href="events.html">Events</a></li>
                        <li><a href="contact.html">Contact</a></li>
                    </ul>
                </div>
            </div>
        </nav>

        <section class="pbs-section pbs-bg-white pbs-border-top" id="book-section">
            <div class="container">
                <div class="row">
                    <div class="col-md-6 col-md-offset-3 text-center section-heading pbs-animate">
                        <h2>Search Result(s)</h2>
                    </div>
                </div>
                <!-- This is where the books will be rendered -->
                <div id="book-container" class="row">
                    <!-- Books will be added here dynamically -->

                </div>
            </div>
        </section>

        <script src="js/scripts.min.js"></script>
        <script src="js/main.min.js"></script>
        <script src="js/custom.js"></script>
        <script>
            const params = new URLSearchParams(window.location.search);
            if (params.get('reload') === 'true') {
                window.location.href = 'index.html';
            }
        </script>
        <script>
            var username = localStorage.getItem('username');
            // Extract the search query from the URL
            var urlParams = new URLSearchParams(window.location.search);
            var query = urlParams.get('query');

            console.log('Query:', query);

            // Fetch and render books based on the search query
            fetch('http://localhost:8080/users/books')
                .then(response => response.json())
                .then(books => {
                    // Get the container element
                    var container = document.getElementById('book-container');
                    console.log(books);

                    // Function to filter and render books based on search query
                    // Function to filter and render books based on search query
                    function renderBooks(searchQuery) {
                        // Clear existing content in the container
                        container.innerHTML = '';
                        console.log(searchQuery);

                        // Check if searchQuery is null or undefined
                        if (!searchQuery) {
                            console.log('No search query provided. Displaying all books.');

                            // Render all books
                            books.forEach(book => {
                                var bookElement = document.createElement('div');
                                bookElement.className = 'col-md-6';

                                bookElement.innerHTML = `
                <div class="pbs-service-2 pbs-animates ">
                    <div class="text " style="width:auto">
                        <h3>${book.title}</h3>
                        <p>${book.author}</p>
                        <p>${book.description}</p>
                        <button class="btn btn-primary order-book-btn" data-username="${username}" data-bookid="${book._id}">Order Book</button>
                    </div>
                </div>
            `;
                                container.appendChild(bookElement);
                            });

                            return;
                        }

                        // Filter books based on the search query
                        const filteredBooks = books.filter(book => {
                            console.log('we are here 2ss22');

                            console.log('Boossks:', book);
                            console.log('SearchQuery:', searchQuery);

                            const isTitleMatch = book.title.toLowerCase().includes(searchQuery.toLowerCase());
                            console.log('Title Match:', isTitleMatch);
                            return (
                                isTitleMatch
                            );
                        });

                        console.log('len of books', filteredBooks.length)

                        if (filteredBooks.length === 0) {
                            alert('No books found!');
                            var noBooksMessage = document.createElement('div');
                            noBooksMessage.className = 'col-md-12';
                            noBooksMessage.innerHTML = '<p>No available books</p>';
                            container.appendChild(noBooksMessage);
                            return;
                        }

                        // Loop through the filtered books and create the book elements
                        filteredBooks.forEach(book => {
                            var bookElement = document.createElement('div');
                            bookElement.className = 'col-md-6';

                            bookElement.innerHTML = `
            <div class="pbs-service-2 pbs-animates ">
                <div class="text " style="width:auto">
                    <h3>${book.title}</h3>
                    <p>${book.author}</p>
                    <p>${book.description}</p>
                    <button class="btn btn-primary order-book-btn" data-username="${username}" data-bookid="${book._id}">Borrow Book</button>
                </div>
            </div>
        `;
                            container.appendChild(bookElement);
                            console.log(container);
                        });

                        document.querySelectorAll('.order-book-btn').forEach(button => {
                            button.addEventListener('click', async (event) => {
                                const username = event.target.getAttribute('data-username');
                                const bookId = event.target.getAttribute('data-bookid');

                                // Make a POST request to the specified route
                                try {
                                    const response = await fetch(`http://localhost:8080/BorrowedBooks/borrow/${username}/${bookId}`, {
                                        method: 'POST',
                                    });

                                    if (response.ok) {
                                        // Handle success (e.g., show a success message)
                                        console.log('Book borrowed successfully');
                                        alert('Book borrowed successfully')
                                    } else {
                                        // Handle errors (e.g., show an error message)
                                        console.error('Failed to borrow book');
                                    }
                                } catch (error) {
                                    console.error('An error occurred:', error);
                                }
                            });
                        });
                    }


                    // Call the renderBooks function with the search query
                    renderBooks(query);
                });
        </script>